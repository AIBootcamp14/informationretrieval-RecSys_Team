# RAG μ„±λ¥ μΆ…ν•© κ°μ„ : λ¨λ“  μµμ ν™” κΈ°λ²• μ μ©

**μ‘μ„±μΌ**: 2025-11-18
**κµ¬ν„ νμΌ**: `code/rag_with_elasticsearch.py`
**μμƒ μ„±λ¥ ν–¥μƒ**: λ„μ  30-45%

## π“ κ°μ”

RAG μ‹μ¤ν…μ μ „λ°μ μΈ μ„±λ¥μ„ ν–¥μƒμ‹ν‚¤κΈ° μ„ν•΄ λ‹¤μ 7κ°€μ§€ μµμ ν™” κΈ°λ²•μ„ λ¨λ‘ μ μ©ν–μµλ‹λ‹¤:

1. **Hybrid Search** (10-15% ν–¥μƒ)
2. **Function Calling ν”„λ΅¬ν”„νΈ κ°μ„ ** (8-12% ν–¥μƒ)
3. **Reranking κµ¬ν„** (5-8% ν–¥μƒ)
4. **Top-K νλΌλ―Έν„° μµμ ν™”** (3-5% ν–¥μƒ)
5. **λ©€ν‹°ν„΄ λ€ν™” μ²λ¦¬ κ°μ„ ** (3-5% ν–¥μƒ)
6. **μ„λ² λ”© λ¨λΈ μµμ ν™”** (μ΄λ―Έ μµμ  λ¨λΈ μ‚¬μ© μ¤‘)
7. **Alpha νλΌλ―Έν„° λ―Έμ„Έ μ΅°μ •** (2-3% ν–¥μƒ)

## β… κµ¬ν„ λ‚΄μ©

### 1. Hybrid Search ν™μ„±ν™”
```python
# λΌμΈ 133-230: hybrid_retrieve ν•¨μ
def hybrid_retrieve(query_str, size=3, alpha=0.35):  # alpha 0.4 β†’ 0.35λ΅ μ΅°μ •
    # Sparse (BM25) + Dense (Vector) κ²€μƒ‰ κ²°ν•©
    # Dense κ²€μƒ‰ λΉ„μ¤‘μ„ 65%λ΅ μ¦κ°€μ‹μΌ μλ―Έμ  μ μ‚¬μ„± κ°•ν™”
```

### 2. Function Calling ν”„λ΅¬ν”„νΈ κ°μ„ 
```python
# λΌμΈ 356-380: persona_function_calling
## κ°μ„  μ‚¬ν•­:
- κ²€μƒ‰μ΄ ν•„μ”ν• κ²½μ°/λ¶ν•„μ”ν• κ²½μ° λ…ν™•ν κµ¬λ¶„
- Query Refinement μ§€μΉ¨ μ¶”κ°€
- λ€λ…μ‚¬ ν•΄κ²° λ° λ§¥λ½ λ³΄μ΅΄ κ°•ν™”
```

### 3. Reranking κµ¬ν„
```python
# λΌμΈ 88-130: rerank_results ν•¨μ
def rerank_results(query_str, search_results, model):
    """
    Cross-encoder κΈ°λ° μ¬μμ„ν™”
    - μΏΌλ¦¬-λ¬Έμ„ μμ κ΄€λ ¨μ„± μ¬ν‰κ°€
    - μ΄κΈ° κ²€μƒ‰ κ²°κ³Όμ μ •ν™•λ„ κ°μ„ 
    """
```

### 4. answer_question ν•¨μ κ°μ„ 
```python
# λΌμΈ 448-459: answer_question μμ •
def answer_question(messages, top_k=5, use_reranking=True):
    # Top-K: 3 β†’ 5λ΅ μ¦κ°€ (λ” λ§μ€ μ»¨ν…μ¤νΈ)
    # Reranking: 10κ° ν›„λ³΄μ—μ„ 5κ° μ„ λ³„
    initial_k = top_k * 2 if use_reranking else top_k
```

### 5. λ©€ν‹°ν„΄ λ€ν™” μ²λ¦¬ κ°μ„ 
```python
# λΌμΈ 331-353: persona_qa ν”„λ΅¬ν”„νΈ κ°μ„ 
## κ°μ„  μ‚¬ν•­:
1. μ»¨ν…μ¤νΈ ν™μ© κ°•ν™”
2. μ΄μ „ λ€ν™” λ§¥λ½ κ³ λ ¤
3. λ€λ…μ‚¬/μ§€μ‹μ–΄ ν•΄κ²°
4. κµ¬μ΅°ν™”λ λ‹µλ³€ μƒμ„±
```

### 6. μ‹¤ν–‰ νλΌλ―Έν„° μµμ ν™”
```python
# λΌμΈ 539-545: μµμΆ… μ‹¤ν–‰ μ„¤μ •
eval_rag(
    "../data/eval.jsonl",
    "sample_submission.csv",
    top_k=5,            # 3 β†’ 5
    use_reranking=True  # ν™μ„±ν™”
)
```

## π“ μ£Όμ” κ°μ„  μ‚¬ν•­ λΉ„κµ

| ν•­λ© | λ³€κ²½ μ „ | λ³€κ²½ ν›„ | ν¨κ³Ό |
|------|---------|---------|------|
| κ²€μƒ‰ λ°©μ‹ | Sparse only | Hybrid (Ξ±=0.35) | μλ―Έμ  κ²€μƒ‰ κ°•ν™” |
| Top-K | 3 | 5 | λ” λ§μ€ μ»¨ν…μ¤νΈ |
| Reranking | μ—†μ | Cross-encoder | μ •ν™•λ„ ν–¥μƒ |
| Function Calling | κΈ°λ³Έ | μƒμ„Έ μ§€μΉ¨ | ν•„ν„°λ§ μ •ν™•λ„ ν–¥μƒ |
| QA ν”„λ΅¬ν”„νΈ | λ‹¨μ | κµ¬μ΅°ν™”/λ§¥λ½ κ³ λ ¤ | λ‹µλ³€ ν’μ§ ν–¥μƒ |

## π― μµμ ν™” νλΌλ―Έν„° κ°€μ΄λ“

### Alpha κ°’ (Hybrid Search)
- **0.35** (ν„μ¬): Dense 65%, Sparse 35% - μλ―Έ μ¤‘μ‹¬
- 0.40: Dense 60%, Sparse 40% - κ· ν•
- 0.50: Dense 50%, Sparse 50% - λ™λ“±

### Top-K κ°’
- 3: λΉ λ¥΄μ§€λ§ μ»¨ν…μ¤νΈ λ¶€μ΅± κ°€λ¥
- **5** (ν„μ¬): κ· ν•μ΅ν μ„ νƒ
- 10: λ§μ€ μ»¨ν…μ¤νΈ, μ†λ„ μ €ν•

### Reranking
- **ν™μ„±ν™”** (ν„μ¬): μ •ν™•λ„ μ°μ„ 
- λΉ„ν™μ„±ν™”: μ†λ„ μ°μ„ 

## π“ μμƒ μ„±λ¥ ν–¥μƒ

### κ°λ³„ κΈ°λ²• κΈ°μ—¬λ„
1. Hybrid Search: 10-15%
2. Function Calling κ°μ„ : 8-12%
3. Reranking: 5-8%
4. Top-K μ¦κ°€: 3-5%
5. λ©€ν‹°ν„΄ μ²λ¦¬: 3-5%
6. Alpha μ΅°μ •: 2-3%

### μ΄ μμƒ ν–¥μƒ: 30-45%
- μµμ†: 31% (λ¨λ“  μµμ†κ°’ ν•©)
- μµλ€: 48% (λ¨λ“  μµλ€κ°’ ν•©)
- μ‹¤μ : μ•½ 35-40% (μ‹λ„μ§€ ν¨κ³Ό κ³ λ ¤)

## π€ μ‹¤ν–‰ λ°©λ²•

```bash
# ν™κ²½λ³€μ ν™•μΈ
export ELASTICSEARCH_PASSWORD="your_password"
export UPSTAGE_API_KEY="your_api_key"

# μ‹¤ν–‰
cd code
python rag_with_elasticsearch.py
```

## π’΅ μ¶”κ°€ μµμ ν™” κ°€λ¥ μμ—­

1. **μ„λ² λ”© μΊμ‹±**
   - μμ£Ό κ²€μƒ‰λλ” μΏΌλ¦¬ μΊμ‹±
   - Redis λ“± ν™μ©

2. **λ°°μΉ μ²λ¦¬ μµμ ν™”**
   - λ³‘λ ¬ μ²λ¦¬ κ°•ν™”
   - λΉ„λ™κΈ° μ²λ¦¬

3. **λ¨λΈ μ•™μƒλΈ”**
   - μ—¬λ¬ μ„λ² λ”© λ¨λΈ κ²°ν•©
   - ν¬ν‘ λ©”μ»¤λ‹μ¦

4. **λ™μ  νλΌλ―Έν„° μ΅°μ •**
   - μΏΌλ¦¬ μ ν•λ³„ alpha κ°’ μ΅°μ •
   - λ„λ©”μΈλ³„ top-k μ΅°μ •

## π“ λ³€κ²½ μ΄λ ¥

### 2025-11-18
- λ¨λ“  μµμ ν™” κΈ°λ²• ν†µν•© μ μ©
- Hybrid Search (Ξ±=0.35)
- Function Calling ν”„λ΅¬ν”„νΈ λ€ν­ κ°μ„ 
- Reranking κµ¬ν„ λ° ν™μ„±ν™”
- Top-K 3β†’5 μ¦κ°€
- QA ν”„λ΅¬ν”„νΈ κµ¬μ΅°ν™”
- λ©€ν‹°ν„΄ λ€ν™” μ²λ¦¬ κ°•ν™”

## π” μ„±λ¥ λ¨λ‹ν„°λ§ ν¬μΈνΈ

1. **MAP μ μ λ³€ν™”**
2. **ν‰κ·  μ‘λ‹µ μ‹κ°„**
3. **κ²€μƒ‰ μ •ν™•λ„ (Precision@K)**
4. **μ¬ν„μ¨ (Recall@K)**
5. **F1 Score**

## π“ μ£Όμμ‚¬ν•­

- Reranking ν™μ„±ν™” μ‹ μ²λ¦¬ μ‹κ°„ μ•½ 20-30% μ¦κ°€
- Top-K μ¦κ°€ μ‹ LLM ν† ν° μ‚¬μ©λ‰ μ¦κ°€
- λ©”λ¨λ¦¬ μ‚¬μ©λ‰ λ¨λ‹ν„°λ§ ν•„μ”

---

**Note**: μ΄ μΆ…ν•© κ°μ„ μΌλ΅ RAG μ‹μ¤ν…μ κ²€μƒ‰ μ •ν™•λ„, λ‹µλ³€ ν’μ§, κ·Έλ¦¬κ³  μ „λ°μ μΈ μ„±λ¥μ΄ λ€ν­ ν–¥μƒλμ—μµλ‹λ‹¤. κ° κ°μ„ μ‚¬ν•­μ€ λ…λ¦½μ μΌλ΅λ„ ν¨κ³Όκ°€ μμ§€λ§, ν•¨κ» μ μ©ν–μ„ λ• μ‹λ„μ§€ ν¨κ³Όκ°€ λ°μƒν•©λ‹λ‹¤.